bool isrefreshing = false;
                        if (ServiceHost.client != null)
                        {
                            var gettings_history = await ServiceHost.client.return_ChatAsync();
                            if (dg.ItemsSource != null)
                            {
                                var current_history = dg.ItemsSource.Cast<Service_Dagorlad.Chat>().ToList();
                                if (gettings_history != null && gettings_history.Count() > 0)
                                {
                                    var unread = gettings_history.Where(p => !current_history.Any(l => p.dt == l.dt && p.message == l.message && p.email == l.email)).ToList();
                                    if (unread.Count() > 0)
                                    {
                                        foreach (var s in unread)
                                        {
                                            if (s.email != Properties.Settings.Default.perhabsemail)
                                            {
                                                NotifyWindowCustom.ShowNotify(s.nickname, s.message ?? "[Cтикер]", "notify_chat.png", 5, false, typeof(Chat),"ALL");
                                                FlashWindow.Do_FlashWindow(this, 3);
                                            }
                                        }
                                        if (listofusersLB.SelectedItem != null && (listofusersLB.SelectedValue as ListBoxItem) != null 
                                        && (listofusersLB.SelectedValue as ListBoxItem).Content.ToString()=="Общий")
                                        {
                                            current_history.AddRange(unread);
                                            CarretToBottom();
                                            isrefreshing = true;
                                        }
                                    }
                                }
                                if (ServiceHost.list != null && ServiceHost.list.Count() > 0)
                                {
                                    CountOnlinelbl.Content = ServiceHost.list.Count();
                                    var user_is_existing = false;
                                    // add user list dialog
                                    foreach(var user in ServiceHost.list)
                                    {
                                        foreach (var existinguser in listofusersLB.Items)
                                        {
                                            if (existinguser.GetType() == typeof(ListBoxItem))
                                            {
                                                var item = (ListBoxItem)existinguser;
                                                var obj = item.DataContext as Service_Dagorlad.Info;
                                                if (obj!=null && obj.perhabs_email==user.perhabs_email && obj.perhabs_fio==user.perhabs_fio)
                                                {
                                                    user_is_existing = true;
                                                }
                                            }
                                        }
                                        if (!user_is_existing)
                                        {
                                            ListBoxItem userli = new ListBoxItem();
                                            userli.DataContext = user;
                                            userli.Content = user.perhabs_fio;

                                            // event click user btn
                                            userli.Selected += async (q, e) =>
                                            {

                                                var from_id = "Диалог с " + Properties.Settings.Default.perhabsfio + " - " + Properties.Settings.Default.perhabsemail;
                                                var to_id = "Диалог с " + user.perhabs_fio + " - " + user.perhabs_email;
                                                //await ServiceHost.client.AddMessageDialogAsync(new Service_Dagorlad.Dialog {
                                                //    from=from_id,
                                                //    to=to_id,
                                                //    dialog=new Service_Dagorlad.Chat {
                                                //        dt=DateTime.Now,
                                                //        message="test dialog",
                                                //    },
                                                //});
                                                var gettings_dialog_history = await ServiceHost.client.return_DialogAsync(from_id,to_id);
                                                if (gettings_dialog_history != null && gettings_dialog_history.Count() > 0)
                                                {
                                                    var unread = gettings_dialog_history.Where(p => !current_history.Any(l => p.dialog.dt == l.dt && p.dialog.message == l.message && p.dialog.email == l.email)).ToList();
                                                    if (unread.Count() > 0)
                                                    {
                                                        foreach (var s in unread)
                                                        {
                                                            if (s.dialog.email != Properties.Settings.Default.perhabsemail)
                                                            {
                                                                //NotifyWindowCustom.ShowNotify(s.nickname, s.message ?? "[Cтикер]", "notify_chat.png", 5, false, typeof(Chat), "ALL");
                                                                FlashWindow.Do_FlashWindow(this, 3);
                                                            }
                                                        }
                                                        current_history.AddRange(unread.Select(x=>x.dialog));
                                                        CarretToBottom();
                                                        isrefreshing = true;
                                                    }
                                                }   
                                            };
                                            //
                                            listofusersLB.Items.Add(userli);
                                        }
                                    }
                                    //
                                    foreach (var current in current_history)
                                        foreach (var online in ServiceHost.list)
                                            if (current.email == online.perhabs_email)
                                                current.isonline = true;
                                }
                                if (isrefreshing)
                                    dg.ItemsSource = current_history;
                            }
                            else dg.ItemsSource = gettings_history.ToList();
                            if (!isfirsttimecarrete)
                            {
                                CarretToBottom();
                                isfirsttimecarrete = true;
                            }
                        }